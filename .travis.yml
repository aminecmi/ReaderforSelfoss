language: android

jdk:
  - oraclejdk8

android:
  components:
    - tools
    - platform-tools
    - tools

    - build-tools-26.0.0

    - android-26
    - android-22

    - extra-google-google_play_services
    - extra-google-m2repository
    - extra-android-m2repository
    - extra-android-support

    - add-on
    - extra

    - sys-img-armeabi-v7a-android-22

  licenses:
    - 'android-sdk-license-.+'
    - 'google-gdk-license-.+'

before_script:
  - mkdir app/src/main/res/mipmap-hdpi
  - convert -size 72x72 xc:white app/src/main/res/mipmap-hdpi/ic_launcher.png
  - mkdir app/src/main/res/mipmap-mdpi
  - convert -size 48x48 xc:white app/src/main/res/mipmap-mdpi/ic_launcher.png
  - mkdir app/src/main/res/mipmap-xhdpi
  - convert -size 96x96 xc:white app/src/main/res/mipmap-xhdpi/ic_launcher.png
  - mkdir app/src/main/res/mipmap-xxhdpi
  - convert -size 192x192 xc:white app/src/main/res/mipmap-xxhdpi/ic_launcher.png
  - mkdir app/src/main/res/mipmap-xxxhdpi
  - convert -size 512x512 xc:white app/src/main/res/mipmap-xxxhdpi/ic_launcher.png

  - echo no | android create avd --force -n test -t android-22 --abi armeabi-v7a
  - emulator -avd test -no-audio -no-window &
  - android-wait-for-emulator
  - adb shell input keyevent 82 &
  - adb shell input tap 650 300 &

script:
  - ./gradlew assemble --configure-on-demand --no-daemon -P crashlyticsdemoApikey=$FABRIC_API_KEY -P crashlyticsdemoApisecret=$FABRIC_API_SECRET -P appLoginUrl=$LOGIN_URL -P appLoginUsername=$LOGIN_USER_NAME -P appLoginPassword=$LOGIN_PASSWORD -PdisablePreDex -Pandroid.threadPoolSize=1 -Porg.gradle.parallel=false
  - ./gradlew connectedAndroidTest --configure-on-demand --no-daemon --stacktrace -P crashlyticsdemoApikey=$FABRIC_API_KEY -P crashlyticsdemoApisecret=$FABRIC_API_SECRET -P appLoginUrl=$LOGIN_URL -P appLoginUsername=$LOGIN_USER_NAME -P appLoginPassword=$LOGIN_PASSWORD -PdisablePreDex -Pandroid.threadPoolSize=1 -Porg.gradle.parallel=false


before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/.android/build-cache

before_install:
  - openssl aes-256-cbc -K $encrypted_cab814aaeabc_key -iv $encrypted_cab814aaeabc_iv
    -in secrets.tar.enc -out secrets.tar -d
  - tar xvf secrets.tar
